apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: kubernetes-pod-watch
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: node:18-alpine
        ports:
        - containerPort: 54321
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: pod-watch-secrets
              key: DATABASE_URL
        - name: API_PORT
          valueFrom:
            configMapKeyRef:
              name: pod-watch-config
              key: API_PORT
        command: ["/bin/sh"]
        args:
          - -c
          - |
            apk add --no-cache curl &&
            cd /app &&
            npm install -g pg &&
            cat > server.mjs << 'EOF'
            #!/usr/bin/env node
            import { createServer } from 'node:http';
            import pg from 'pg';
            
            const { Pool } = pg;
            const DB_URL = process.env.DATABASE_URL;
            const PORT = parseInt(process.env.API_PORT || '54321', 10);
            
            const pool = new Pool({ connectionString: DB_URL });
            
            const corsHeaders = {
              'Access-Control-Allow-Origin': '*',
              'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
              'Content-Type': 'application/json',
            };
            
            const server = createServer(async (req, res) => {
              if (req.method === 'OPTIONS') {
                res.writeHead(204, corsHeaders);
                res.end();
                return;
              }
            
              const url = new URL(req.url || '/', `http://localhost:${PORT}`);
              if (url.pathname !== '/functions/v1/database') {
                res.writeHead(404, corsHeaders);
                res.end(JSON.stringify({ error: 'Not found' }));
                return;
              }
            
              const action = url.searchParams.get('action');
            
              try {
                let result;
            
                switch (action) {
                  case 'getPods': {
                    const podsRes = await pool.query(\`
                      SELECT id, name, namespace, status, node_name, pod_ip, labels, restarts, created_at, updated_at
                      FROM pods ORDER BY created_at DESC
                    \`);
                    const containersRes = await pool.query(\`
                      SELECT id, pod_id, name, image, status, ready, restart_count, started_at,
                             last_state_reason, last_state_exit_code, last_state_message, created_at, updated_at
                      FROM containers
                    \`);
                    result = { pods: podsRes.rows, containers: containersRes.rows };
                    break;
                  }
                  case 'getLogs': {
                    const containerId = url.searchParams.get('containerId');
                    if (!containerId) throw new Error('containerId is required');
                    const logsRes = await pool.query(
                      \`SELECT id, container_id, timestamp, level, message, created_at
                       FROM logs WHERE container_id = \$1 ORDER BY timestamp ASC\`,
                      [containerId]
                    );
                    result = { logs: logsRes.rows };
                    break;
                  }
                  case 'health': {
                    await pool.query('SELECT 1');
                    result = { status: 'healthy', timestamp: new Date().toISOString() };
                    break;
                  }
                  default:
                    throw new Error(\`Unknown action: \${action}\`);
                }
            
                res.writeHead(200, corsHeaders);
                res.end(JSON.stringify(result));
              } catch (err) {
                console.error('Database error:', err);
                res.writeHead(500, corsHeaders);
                res.end(JSON.stringify({ error: err.message || 'Unknown error' }));
              }
            });
            
            server.listen(PORT, () => {
              console.log(\`Backend API: http://localhost:\${PORT}/functions/v1/database\`);
            });
            EOF
            node server.mjs
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /functions/v1/database?action=health
            port: 54321
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /functions/v1/database?action=health
            port: 54321
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: kubernetes-pod-watch
spec:
  selector:
    app: backend
  ports:
  - port: 54321
    targetPort: 54321
  type: ClusterIP
