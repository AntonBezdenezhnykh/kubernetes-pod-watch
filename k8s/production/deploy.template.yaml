apiVersion: v1
kind: Namespace
metadata:
  name: ${APP_NAMESPACE}
  labels:
    app.kubernetes.io/name: ${APP_NAME}
    app.kubernetes.io/version: "${APP_VERSION}"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ${APP_NAME}-sa
  namespace: ${APP_NAMESPACE}
  labels:
    app.kubernetes.io/name: ${APP_NAME}
    app.kubernetes.io/version: "${APP_VERSION}"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ${APP_NAME}-reader
  labels:
    app.kubernetes.io/name: ${APP_NAME}
    app.kubernetes.io/version: "${APP_VERSION}"
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log", "namespaces"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["nodes", "nodes/proxy"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["metrics.k8s.io"]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ${APP_NAME}-reader-binding
  labels:
    app.kubernetes.io/name: ${APP_NAME}
    app.kubernetes.io/version: "${APP_VERSION}"
subjects:
  - kind: ServiceAccount
    name: ${APP_NAME}-sa
    namespace: ${APP_NAMESPACE}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ${APP_NAME}-reader
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ${APP_NAME}-config
  namespace: ${APP_NAMESPACE}
  labels:
    app.kubernetes.io/name: ${APP_NAME}
    app.kubernetes.io/version: "${APP_VERSION}"
data:
  APP_VERSION: "${APP_VERSION}"
  API_PORT: "${CONTAINER_PORT}"
  PORT: "${CONTAINER_PORT}"
  STATIC_DIR: /app/dist
  DB_HOST: "${DB_HOST}"
  DB_PORT: "${DB_PORT}"
  DB_NAME: "${DB_NAME}"
  DB_USER: "${DB_USER}"
  DB_SSL: "${DB_SSL}"
  TARGET_NAMESPACE: "${TARGET_NAMESPACE}"
  LOG_TAIL_LINES: "${LOG_TAIL_LINES}"
  SAMPLE_INTERVAL_SECONDS: "${SAMPLE_INTERVAL_SECONDS}"
---
apiVersion: v1
kind: Secret
metadata:
  name: ${APP_NAME}-secrets
  namespace: ${APP_NAMESPACE}
  labels:
    app.kubernetes.io/name: ${APP_NAME}
    app.kubernetes.io/version: "${APP_VERSION}"
type: Opaque
stringData:
  DB_PASSWORD: "${DB_PASSWORD}"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${APP_NAME}
  namespace: ${APP_NAMESPACE}
  labels:
    app.kubernetes.io/name: ${APP_NAME}
    app.kubernetes.io/version: "${APP_VERSION}"
spec:
  replicas: ${APP_REPLICAS}
  selector:
    matchLabels:
      app.kubernetes.io/name: ${APP_NAME}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ${APP_NAME}
        app.kubernetes.io/version: "${APP_VERSION}"
    spec:
      serviceAccountName: ${APP_NAME}-sa
      containers:
        - name: app
          image: ${APP_IMAGE}
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: ${APP_NAME}-config
            - secretRef:
                name: ${APP_NAME}-secrets
          ports:
            - containerPort: ${CONTAINER_PORT}
              name: http
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 15
            periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: ${APP_NAME}
  namespace: ${APP_NAMESPACE}
  labels:
    app.kubernetes.io/name: ${APP_NAME}
    app.kubernetes.io/version: "${APP_VERSION}"
spec:
  type: ${SERVICE_TYPE}
  selector:
    app.kubernetes.io/name: ${APP_NAME}
  ports:
    - name: http
      port: ${SERVICE_PORT}
      targetPort: http
      protocol: TCP
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ${APP_NAME}-collector
  namespace: ${APP_NAMESPACE}
  labels:
    app.kubernetes.io/name: ${APP_NAME}-collector
    app.kubernetes.io/version: "${APP_VERSION}"
spec:
  schedule: "${COLLECT_SCHEDULE}"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: ${APP_NAME}-collector
            app.kubernetes.io/version: "${APP_VERSION}"
        spec:
          serviceAccountName: ${APP_NAME}-sa
          restartPolicy: OnFailure
          containers:
            - name: collector
              image: ${APP_IMAGE}
              imagePullPolicy: IfNotPresent
              command: ["node", "scripts/k8s-collector.mjs"]
              envFrom:
                - configMapRef:
                    name: ${APP_NAME}-config
                - secretRef:
                    name: ${APP_NAME}-secrets
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${APP_NAME}-resource-collector
  namespace: ${APP_NAMESPACE}
  labels:
    app.kubernetes.io/name: ${APP_NAME}-resource-collector
    app.kubernetes.io/version: "${APP_VERSION}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ${APP_NAME}-resource-collector
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ${APP_NAME}-resource-collector
        app.kubernetes.io/version: "${APP_VERSION}"
    spec:
      serviceAccountName: ${APP_NAME}-sa
      restartPolicy: Always
      containers:
        - name: resource-collector
          image: ${APP_IMAGE}
          imagePullPolicy: IfNotPresent
          command: ["node", "scripts/k8s-resource-collector.mjs"]
          envFrom:
            - configMapRef:
                name: ${APP_NAME}-config
            - secretRef:
                name: ${APP_NAME}-secrets
