apiVersion: v1
kind: Namespace
metadata:
  name: pod-watch
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pod-watch-sa
  namespace: pod-watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-watch-reader
  namespace: pod-watch
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pod-watch-reader-binding
  namespace: pod-watch
subjects:
  - kind: ServiceAccount
    name: pod-watch-sa
    namespace: pod-watch
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: pod-watch-reader
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pod-watch
  namespace: pod-watch
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pod-watch
  template:
    metadata:
      labels:
        app: pod-watch
    spec:
      serviceAccountName: pod-watch-sa
      containers:
        - name: app
          image: kubernetes-pod-watch:local
          imagePullPolicy: IfNotPresent
          env:
            - name: DB_HOST
              value: host.docker.internal
            - name: DB_PORT
              value: "5432"
            - name: DB_NAME
              value: postgres
            - name: DB_USER
              value: postgres
            - name: DB_PASSWORD
              value: ""
            - name: DB_SSL
              value: "false"
            - name: PORT
              value: "8080"
            - name: API_PORT
              value: "8080"
            - name: STATIC_DIR
              value: /app/dist
          ports:
            - containerPort: 8080
              name: http
---
apiVersion: v1
kind: Service
metadata:
  name: pod-watch
  namespace: pod-watch
spec:
  type: LoadBalancer
  selector:
    app: pod-watch
  ports:
    - port: 8080
      targetPort: http
      protocol: TCP
      name: http
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pod-watch-collector
  namespace: pod-watch
spec:
  schedule: "*/2 * * * *"
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: pod-watch-sa
          restartPolicy: OnFailure
          containers:
            - name: collector
              image: kubernetes-pod-watch:local
              imagePullPolicy: IfNotPresent
              command: ["node", "scripts/k8s-collector.mjs"]
              env:
                - name: TARGET_NAMESPACE
                  value: pod-watch
                - name: LOG_TAIL_LINES
                  value: "100"
                - name: DB_HOST
                  value: host.docker.internal
                - name: DB_PORT
                  value: "5432"
                - name: DB_NAME
                  value: postgres
                - name: DB_USER
                  value: postgres
                - name: DB_PASSWORD
                  value: ""
                - name: DB_SSL
                  value: "false"
